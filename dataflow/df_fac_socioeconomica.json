{
	"name": "df_fac_socioeconomica",
	"properties": {
		"folder": {
			"name": "DF_INSCRIPCIONES_MATRICULAS/FAC_SOCIOECONOMICA"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "FAC_SOCIOECONOMICA_PARQUET",
						"type": "DatasetReference"
					},
					"name": "source"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "FAC_INSCRIPCION_PARQUET",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "derivedColumn"
				},
				{
					"name": "definciontipodecampo"
				},
				{
					"name": "actualizacionycreaciondelhash"
				},
				{
					"name": "verificaciondeduplicados"
				}
			],
			"scriptLines": [
				"source(output(",
				"          CODIGO_INTERNO_PERIODO_VAL_FICHA as decimal(38,18),",
				"          CODIGO_INTERNO_POS_ALU as decimal(38,18),",
				"          CODIGO_INTERNO_RANGO_FICHA as decimal(38,18),",
				"          VALORACION as decimal(38,18),",
				"          AUD_FECHA_ADICION as timestamp,",
				"          AUD_FECHA_MODIFICACION as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet') ~> source",
				"source derive(CODIGO_INTERNO_PERIODO_VAL_FICHA = iifNull(CODIGO_INTERNO_PERIODO_VAL_FICHA, -1),",
				"          CODIGO_INTERNO_POS_ALU = iifNull(CODIGO_INTERNO_POS_ALU, -1),",
				"          CODIGO_INTERNO_RANGO_FICHA = iifNull(CODIGO_INTERNO_RANGO_FICHA, -1),",
				"          VALORACION = iifNull(VALORACION, -1),",
				"          AUD_FECHA_ADICION = iif(    isNull(AUD_FECHA_ADICION) || toString(AUD_FECHA_ADICION) == '',    toDate('1900-01-01'),    toDate(toString(AUD_FECHA_ADICION, 'yyyy-MM-dd'))),",
				"          AUD_FECHA_MODIFICACION = iif(    isNull(AUD_FECHA_MODIFICACION) || toString(AUD_FECHA_MODIFICACION) == '',    toDate('1900-01-01'),    toDate(toString(AUD_FECHA_MODIFICACION, 'yyyy-MM-dd')))) ~> derivedColumn",
				"verificaciondeduplicados cast(output(",
				"          HASH as string,",
				"          estado_inscripcion as string,",
				"          fecha_inscripcion as date,",
				"          fecha_aprobacion as date,",
				"          jornada as string,",
				"          tiene_matricula as boolean,",
				"          tipo_inscripcion as string,",
				"          vigencia_inscripcion as boolean,",
				"          codigo_interno_periodo as integer,",
				"          codigo_interno_pos_alu as integer,",
				"          codigo_interno_programa_academico as string,",
				"          aud_fecha_adicion as date,",
				"          aud_fecha_modificacion as date,",
				"          FECHA_ULTIMA_ACTUALIZACION as date,",
				"          LINAJE as string",
				"     ),",
				"     errors: true) ~> definciontipodecampo",
				"derivedColumn derive(HASH = md5(concat(estado_inscripcion, toString(fecha_inscripcion), toString(fecha_aprobacion), jornada, tiene_matricula, tipo_inscripcion, vigencia_inscripcion, toString(codigo_interno_periodo), toString(derivedColumn@codigo_interno_pos_alu), toString(codigo_interno_programa_academico), toString(derivedColumn@aud_fecha_adicion), toString(derivedColumn@aud_fecha_modificacion))),",
				"          FECHA_ULTIMA_ACTUALIZACION = currentTimestamp(),",
				"          LINAJE = 'ins_alumno, cliente_local, ins_raza, ins_estado_civil') ~> actualizacionycreaciondelhash",
				"actualizacionycreaciondelhash aggregate(groupBy(HASH),",
				"     estado_inscripcion = max(estado_inscripcion),",
				"          fecha_inscripcion = max(fecha_inscripcion),",
				"          fecha_aprobacion = max(fecha_aprobacion),",
				"          jornada = max(jornada),",
				"          tiene_matricula = max(tiene_matricula),",
				"          tipo_inscripcion = max(tipo_inscripcion),",
				"          vigencia_inscripcion = max(vigencia_inscripcion),",
				"          codigo_interno_periodo = max(codigo_interno_periodo),",
				"          codigo_interno_pos_alu = max(derivedColumn@codigo_interno_pos_alu),",
				"          codigo_interno_programa_academico = max(codigo_interno_programa_academico),",
				"          aud_fecha_adicion = max(derivedColumn@aud_fecha_adicion),",
				"          aud_fecha_modificacion = max(derivedColumn@aud_fecha_modificacion),",
				"          FECHA_ULTIMA_ACTUALIZACION = max(FECHA_ULTIMA_ACTUALIZACION),",
				"          LINAJE = max(LINAJE)) ~> verificaciondeduplicados",
				"definciontipodecampo sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'parquet',",
				"     partitionFileNames:['FAC_INSCRIPCION_FINAL.parquet'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> sink1"
			]
		}
	}
}